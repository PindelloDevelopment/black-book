<!DOCTYPE html>
<html lang="en">

    <meta charset="UTF-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@200;300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../Style/Style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&family=Raleway:wght@600&display=swap" rel="stylesheet">
    <title>Call Today</title>
    <header>

        <nav class=" navbar navbar-expand-lg navbar-light bg-light">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
                <a class="navbar-brand" href="/"><svg xmlns="http://www.w3.org/2000/svg" width="50" height="30" fill="currentColor" class="bi bi-incognito" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="m4.736 1.968-.892 3.269-.014.058C2.113 5.568 1 6.006 1 6.5 1 7.328 4.134 8 8 8s7-.672 7-1.5c0-.494-1.113-.932-2.83-1.205a1.032 1.032 0 0 0-.014-.058l-.892-3.27c-.146-.533-.698-.849-1.239-.734C9.411 1.363 8.62 1.5 8 1.5c-.62 0-1.411-.136-2.025-.267-.541-.115-1.093.2-1.239.735Zm.015 3.867a.25.25 0 0 1 .274-.224c.9.092 1.91.143 2.975.143a29.58 29.58 0 0 0 2.975-.143.25.25 0 0 1 .05.498c-.918.093-1.944.145-3.025.145s-2.107-.052-3.025-.145a.25.25 0 0 1-.224-.274ZM3.5 10h2a.5.5 0 0 1 .5.5v1a1.5 1.5 0 0 1-3 0v-1a.5.5 0 0 1 .5-.5Zm-1.5.5c0-.175.03-.344.085-.5H2a.5.5 0 0 1 0-1h3.5a1.5 1.5 0 0 1 1.488 1.312 3.5 3.5 0 0 1 2.024 0A1.5 1.5 0 0 1 10.5 9H14a.5.5 0 0 1 0 1h-.085c.055.156.085.325.085.5v1a2.5 2.5 0 0 1-5 0v-.14l-.21-.07a2.5 2.5 0 0 0-1.58 0l-.21.07v.14a2.5 2.5 0 0 1-5 0v-1Zm8.5-.5h2a.5.5 0 0 1 .5.5v1a1.5 1.5 0 0 1-3 0v-1a.5.5 0 0 1 .5-.5Z"/>
                    </svg>My Application's</a>
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="./Blackbook.html" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Salesforce Application
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="./Blackbook.html">Home</a></li>
                            <li><a class="dropdown-item" href="./Call_Today.html"><span class="red">Call Today</span></a></li>
                            <li><a class="dropdown-item" href="./Birthdays.html">Birthday's</a></li>
                            <li><a class="dropdown-item" href="./Account_Executive.html">Account Executives</a></li>
                            <li><a class="dropdown-item" href="#">Account Director's</a></li>
                            <li><a class="dropdown-item" href="#">RVP's</a></li>
                            <li><a class="dropdown-item" href="./Company_House_Search.html">Search Querie's</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Tasks Application</a>
                    </li>

                </ul>
            </div>
        </nav>


    </header>






    <body>
        <div class="banner">
            <h1 class="salesforceblue">Call Todays</h1>


            <div class="box"></div>
            <div class="box"></div>
            <div class="box"></div>
        </div>
        <div class="container-fluid p-3">
            <div class="d-flex w-25">
                <input id ="search_Firstname" class="form-control me-2" type="search" placeholder="Firstname" aria-label="Search">
                <button id = "search_button" class="btn btn-outline-success">Search</button>
            </div>
        </div>
        <div class="container-fluid p-3">
            <button id = "createAccount" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#createAccountForm">Create Account</button>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">Firstname</th>
                    <th scope="col">Lastname</th>
                    <th scope="col">Active</th>
                    <th scope="col">Email</th>
                    <th scope="col">Linkedin</th>
                    <th scope="col">Birthday</th>
                    <th scope="col">Location</th>
                    <th scope="col">Serving</th>
                    <th scope="col">Title</th>
                    <th scope="col">Department</th>
                    <th scope="col">Exposure</th>
                    <th scope="col">Current Company</th>
                    <th scope="col"> Days Warning</th>
                    <th scope="col">Last Contact</th>
                    <th scope="col"> Days Since Last Contact</th>
                    <th scope="col"> Warning</th>
                    <th scope="col">Last Comment</th>
                    <th scope="col">Update</th>
                    <th scope="col">Delete</th>

                <tr>
            </thead>
            <tbody id="tableContent">
            </tbody>
        </table>
        <script>
            document.getElementById('search_button').addEventListener('click', function () {
                const searchValue = document.getElementById('search_Firstname').value.toLowerCase();
                const tableRows = document.querySelectorAll('#tableContent tr');

                tableRows.forEach(row => {
                    const firstNameCell = row.cells[0].textContent.toLowerCase();
                    if (firstNameCell.includes(searchValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        </script>
        <!--create account form --> 
        <div class="modal fade" id="createAccountForm" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="createAccountFormLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createAccountFormLabel">Create Executive Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="form_createAccount" method="POST">
                            <div class="mb-3">
                                <label for="create_Firstname" class="form-label">Firstname:</label>
                                <input type="text" class="form-control" id="create_Firstname" name="Firstname" required>
                            </div>
                            <div class="mb-3">
                                <label for="create_Lastname" class="form-label">Lastname:</label>
                                <input type="text" class="form-control" id="create_Lastname" name="Lastname" required>
                            </div>
                            <div class="mb-3">
                                <label for="create_Active" class="form-label">Active:</label>
                                <select id="create_Active" name="Active">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="create_Email" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="create_Email" name="Email" required>
                            </div>
                            <div class="mb-3">
                                <label for="create_Linkedin" class="form-label">Linkedin:</label>
                                <input type="text" class="form-control" id="create_Linkedin" name="Linkedin" required>
                            </div>
                            <div class="mb-3">
                                <label for="create_Birthday" class="form-label">Birthday:</label>
                                <input type="date" class="form-control" id="create_Birthday" name="Birthday" required>
                            </div>

                            <!-- Location Dropdown -->
                            <div class="mb-3">
                                <label for="create_Location" class="form-label">Location:</label>
                                <select id="create_Location" name="Location" required>
                                    <option value="Location1">Location 1</option>
                                    <option value="Location2">Location 2</option>
                                </select>
                            </div>

                            <!-- Serving Dropdown -->
                            <div class="mb-3">
                                <label for="create_Serving" class="form-label">Serving:</label>
                                <select id="create_Serving" name="Serving" required>
                                    <option value="Serving1">Serving 1</option>
                                    <option value="Serving2">Serving 2</option>
                                </select>
                            </div>

                            <!-- Title Input -->
                            <div class="mb-3">
                                <label for="create_Title" class="form-label">Title:</label>
                                <input type="text" class="form-control" id="create_Title" name="Title" required>
                            </div>

                            <!-- Department Dropdown -->
                            <div class="mb-3">
                                <label for="create_Department" class="form-label">Department:</label>
                                <select id="create_Department" name="Department" required>
                                    <option value="Account Executive">Account Executive</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Marketing">Marketing</option>
                                </select>
                            </div>

                            <!-- Exposure Dropdown -->
                            <div class="mb-3">
                                <label for="create_Exposure" class="form-label">Exposure:</label>
                                <select id="create_Exposure" name="Exposure" required>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>

                            <!-- Current Company Input -->
                            <div class="mb-3">
                                <label for="create_CurrentCompany" class="form-label">Current Company:</label>
                                <input type="text" class="form-control" id="create_CurrentCompany" name="CurrentCompany" required>
                            </div>

                            <div class="mb-3">
                                <label for="dayswarning" class="form-label">Days Warning</label>
                                <input type="number" class="form-control" id="create_daysworning" name="DaysWarning">
                            </div>

                            <!-- Last Contact Date -->
                            <div class="mb-3">
                                <label for="create_LastContact" class="form-label">Last Contact:</label>
                                <input type="date" class="form-control" id="create_LastContact" name="LastContact" required>
                            </div>

                            <!-- Last Comments Input -->
                            <div class="mb-3">
                                <label for="create_LastComments" class="form-label">Last Comments:</label>
                                <input type="text" class="form-control" id="create_LastComments" name="LastComments" required>
                            </div>

                            <div class="modal-footer">
                                <button id="createAccountFormClose" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" name="submit" class="btn btn-success" data-bs-dismiss="modal">Create</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>

        <!--update account form --> 
        <div class="modal fade" id="updateAccountForm" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="updateAccountFormLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateAccountFormLabel">Update Executive Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="form_updateAccount" method="POST">
                            <div class="mb-3">
                                <label for="update_Firstname" class="form-label">Firstname:</label>
                                <input type="text" class="form-control" id="update_Firstname" name="Firstname">
                            </div>
                            <div class="mb-3">
                                <label for="update_Lastname" class="form-label">Lastname:</label>
                                <input type="text" class="form-control" id="update_Lastname" name="Lastname">
                            </div>
                            <div class="mb-3">
                                <label for="update_Active" class="form-label">Active:</label>
                                <select id="update_Active" name="Active" required>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="update_Email" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="update_Email" name="Email">
                            </div>
                            <div class="mb-3">
                                <label for="update_Linkedin" class="form-label">Linkedin:</label>
                                <input type="text" class="form-control" id="update_Linkedin" name="Linkedin">
                            </div>
                            <div class="mb-3">
                                <label for="update_Birthday" class="form-label">Birthday:</label>
                                <input type="date" class="form-control" id="update_Birthday" name="Birthday" required>
                            </div>

                            <!-- Additional Fields -->
                            <div class="mb-3">
                                <label for="update_Location" class="form-label">Location:</label>
                                <select id="update_Location" name="Location" required>
                                    <option value="Location1">Location 1</option>
                                    <option value="Location2">Location 2</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="update_Serving" class="form-label">Serving:</label>
                                <select id="update_Serving" name="Serving" required>
                                    <option value="Serving1">Serving 1</option>
                                    <option value="Serving2">Serving 2</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="update_Title" class="form-label">Title:</label>
                                <input type="text" class="form-control" id="update_Title" name="Title">
                            </div>
                            <div class="mb-3">
                                <label for="update_Department" class="form-label">Department:</label>
                                <select id="update_Department" name="Department" required>
                                    <option value="Account Executive">Account Executive</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Marketing">Marketing</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="update_Exposure" class="form-label">Exposure:</label>
                                <select id="update_Exposure" name="Exposure" required>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">low</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="update_CurrentCompany" class="form-label">Current Company:</label>
                                <input type="text" class="form-control" id="update_CurrentCompany" name="CurrentCompany">
                            </div>

                            <div class="mb-3">
                                <label for="Update_DaysWarning" class="form-label">Days Warning</label>
                                <input type="number" class="form-control" id="update_dayswarning" name="DaysWarning">
                            </div>

                            <div class="mb-3">
                                <label for="update_LastContact" class="form-label">Last Contact:</label>
                                <input type="date" class="form-control" id="update_LastContact" name="LastContact" required>
                            </div>
                            <div class="mb-3">
                                <label for="update_LastComments" class="form-label">Last Comments:</label>
                                <textarea class="form-control" id="update_LastComments" name="LastComments"></textarea>
                            </div>

                            <input type="text" id="id_1" name="id" class="d-none">

                            <div class="modal-footer">
                                <button id="updateAccountFormClose" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" name="update" class="btn btn-success">Update</button>
                            </div>
                        </form>            
                    </div>
                </div>
            </div>
        </div>

        <!-- DELETE -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalCenterTitle">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this record?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INSERT/ -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="successModalLabel">Success</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="successMessageContent">
                        <!-- Success message will be injected here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>


        <script src="../js/Account_Executive.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- insert data -->
        <script>

            $(document).ready(function () {
                function fetchData() {
                    $.ajax({
                        url: './calltody_get_data.php',
                        type: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            $('#tableContent').empty(); // Clear existing table content

                            if (data.length > 0) {
                                function formatLastContact(lastContact) {
                                    const lastContactDate = new Date(lastContact);
                                    const today = new Date();

                                    // Set time to midnight for both dates to only compare dates
                                    today.setHours(0, 0, 0, 0);
                                    lastContactDate.setHours(0, 0, 0, 0);

                                    const timeDifference = today - lastContactDate; // Difference in milliseconds
                                    const dayDifference = Math.floor(timeDifference / (1000 * 60 * 60 * 24)); // Convert to days

                                    if (dayDifference === 0) {
                                        return 0; // Today
                                    } else if (dayDifference === 1) {
                                        return 1; // Yesterday
                                    } else {
                                        return dayDifference; // Number of days
                                    }
                                }

                                function caluclate(daysWarning, daysSinceLastContact) {
                                    // Ensure both are numbers
                                    const warning = Number(daysWarning);
                                    const lastContact = Number(daysSinceLastContact);

                                    // Compare the values and return true or false
                                    return warning <= lastContact;
                                }

                                $.each(data, function (index, row) {
                                    const daysSinceLastContact = formatLastContact(row.LastContact);

                                    // Only append the row if `caluclate()` returns true
                                    if (caluclate(row.days_warning, daysSinceLastContact)) {
                                        $('#tableContent').append(
                                                `<tr>
                                <td>${row.Firstname}</td>
                                <td>${row.Lastname}</td>
                                <td>${row.Active}</td>
                                <td>${row.Email}</td>
                                <td>${row.Linkedin}</td>
                                <td>${row.Birthday}</td>
                                <td>${row.Location}</td>
                                <td>${row.Serving}</td>
                                <td>${row.Title}</td>
                                <td>${row.Department}</td>
                                <td>${row.Exposure}</td>
                                <td>${row.CurrentCompany}</td>
                                <td>${row.days_warning}</td>
                                <td>${row.LastContact}</td>
                                <td>${daysSinceLastContact}</td>
                                <td style='text-transform: capitalize;'>${caluclate(row.days_warning, daysSinceLastContact)}</td>
                                <td>${row.LastComments}</td>
                                <td>
                                    <a class='btn btn-warning btn-sm' data-bs-toggle='modal' data-bs-target='#updateAccountForm' onclick='loadUserDetails(${row.id})'>Update</a>
                                </td>
                                <td>
                                    <button class='btn btn-danger btn-sm' data-bs-toggle="modal" data-bs-target="#exampleModalCenter" data-id="${row.id}">Delete</button>
                                </td>
                            </tr>`
                                                );
                                    }
                                });
                            } else {
                                $('#tableContent').append('<tr><td colspan="8" class="text-center">No records found.</td></tr>');
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert('Error fetching data: ' + textStatus);
                        }
                    });
                }


                $('#form_createAccount').on('submit', function (e) {
                    e.preventDefault();

                    $.ajax({
                        url: './save_account.php',
                        type: 'POST',
                        data: $(this).serialize(),
                        dataType: 'json',
                        success: function (response) {
                            if (response.success) {
                                $('#successMessageContent').text(response.message);

                                $('#successModal').modal('show');
                                fetchData();
                                $('#form_createAccount')[0].reset();
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {

                            console.error('AJAX Error:', textStatus, errorThrown);
                            console.error('Response Text:', jqXHR.responseText);
                            alert('Error submitting form: ' + textStatus);
                        }
                    });
                });

                $(document).ready(function () {
                    let deleteId;

                    $('#exampleModalCenter').on('show.bs.modal', function (event) {
                        console.log();
                        const button = $(event.relatedTarget);
                        deleteId = button.data('id');
                    });


                    $('#confirmDelete').on('click', function () {
                        if (deleteId) {
                            $.ajax({
                                url: 'delete_data.php',
                                type: 'POST',
                                data: {delete: true, id: deleteId},
                                dataType: 'json',
                                success: function (response) {
                                    if (response.success) {
                                        $('#exampleModalCenter').modal('hide');

                                        fetchData();
                                    } else {
                                        alert(response.message);
                                    }
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    alert('Error deleting record: ' + textStatus);
                                }
                            });
                        }
                    });
                });


                window.loadUserDetails = function (id) {
                    $.ajax({
                        url: './save_account.php',
                        type: 'GET',
                        data: {id: id},
                        dataType: 'json',
                        success: function (data) {

                            $('#update_Firstname').val(data.Firstname);
                            $('#update_Lastname').val(data.Lastname);
                            $('#update_Active').val(data.Active);
                            $('#update_Email').val(data.Email);
                            $('#update_Linkedin').val(data.Linkedin);
                            $('#update_Birthday').val(data.Birthday);
                            $('#update_Location').val(data.Location);
                            $('#update_Serving').val(data.Serving);
                            $('#update_Title').val(data.Title);
                            $('#update_Department').val(data.Department);
                            $('#update_Exposure').val(data.Exposure);
                            $('#update_CurrentCompany').val(data.CurrentCompany);
                            $('#update_dayswarning').val(data.days_warning);
                            $('#update_LastContact').val(data.LastContact);
                            $('#update_LastComments').val(data.LastComments);
                            $('#id_1').val(data.id);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert('Error loading user details: ' + textStatus);
                        }
                    });
                };

                $('#form_updateAccount').on('submit', function (e) {
                    e.preventDefault();

                    $.ajax({
                        url: './update_data.php',
                        type: 'POST',
                        data: $(this).serialize(),
                        dataType: 'json',
                        success: function (response) {
                            if (response.success) {

                                fetchData();
                                $('#updateAccountForm').modal('hide');
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error('AJAX Error:', textStatus, errorThrown);
                            console.error('Response Text:', jqXHR.responseText);
                            alert('Error updating record: ' + textStatus);
                        }
                    });
                });

                fetchData();
            });

        </script>
        <footer></footer>

</html>